\chapter{アルゴリズム}
\label{chap_Algorism}

従来の Closed hashing では，
衝突ないし probing によりハッシュ値が使用中の場合，
本来１回目の探査でアクセスできるはずの key であっても，
probing により衝突を解決しなくてはならない．
そこで，要素挿入時に，要素位置を整理して挿入する手法を提案する．
これは．挿入時間を犠牲に lookup 速度を向上させることを意味する．
一般に，要素を先頭から末尾までただ辿る場合は，singly linked list を用いる．
今回は，後から挿入位置を整理するため，doubly linked list を用いる．

図 \ref{fig_IpCHashT_struct} に In-place hash table (以下，IpCHashT) のデータ構造を示す．
各要素には key-value pair の他に，linked list のための prev 要素と next 要素を備える．
T\_shift には unsigned int 型を用い，相対位置により linked list を構成する．
これは，ポインタ接続におけるメモリ消費量が無視できないためである．
\footnote{例えば 64 bits CPU の場合，ポインタサイズは 64 bits であるから，T\_key と T\_val が uint64 型の場合，
テープルサイズの 50\% が doubly linked list に由来する．}．

\begin{figure}[h] % 特に強い理由がない限り、[htbp]のような指定はしないでください。
\begin{lstlisting}[language=C++]
template <class T_key, class T_val, typename T_shift>
struct element{
	element(){
		T_shift maxShift = (T_shift) 0; maxShift =~ maxShift;
		prev = maxShift;
		next = (T_shift) 0;
	}
	~element(){}
	
	T_key key;
	T_val val;
	T_shift prev;
	T_shift next;
};
\end{lstlisting}
\caption{
  IpCHashT 要素の C++ 擬似構造体．T\_key は key の型，T\_val は val の型である．
  T\_shift は doubly linked list に用いる型で，uint8 または uint16 を指定する．
  uint16 より大きな型を指定するメリットは殆どない．
  prev は 前の要素までの相対距離を，next は 次の要素までの相対距離を表す．
  ポインタにおけるアドレスとは異なり，区間 [0, max(T\_shift) - 1] の範囲でリンクを表現する．
  ただし，max(T\_shift) は T\_shift 型の取り得る最大値である．
  0 のときに自分自身を示し，max(T\_shift) - 1 がリンクできる最大距離である．区間外へのリンクはできない．
  max(T\_shift) は，予約されており，'prev==max(T\_shift)' のとき，要素が空であることを示す．
  また，'prev==0' であれば linked list の先頭であること，'next==0' であれば linked list の末尾であることが分かる．
}
\label{fig_IpCHashT_struct}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_01.pdf}
  \caption{ Description of the symbols. }
  \label{fig_IpCHashT_fig_description}
\end{figure}

図\ref{fig_IpCHashT_fig_description}に，
%図\ref{fig_IpCHashT_apparence}〜\ref{fig_IpCHashT_insert_introspection}，
%図\ref{fig_IpCHashT_insert_hard_case01}〜\ref{fig_IpCHashT_insert_hard_case11} および
%図\ref{fig_IpCHashT_deletion_case01}〜\ref{fig_IpCHashT_deletion_case06}で用いる記号を示す．
図\ref{fig_IpCHashT_apparence}〜\ref{fig_IpCHashT_deletion_case06}で用いる記号を示す．
各図は，青字を初期状態とし，赤字が挿入時の変更を，緑字は要素の移動に伴う変更を，それぞれ表す．

図\ref{fig_IpCHashT_apparence}〜\ref{fig_IpCHashT_deletion_case06}では，
丸印ひとつ一つが配列要素を表しており，
双方向に張られた 2 つの矢印により doubly linked list を構成している．
Open hashing を用いたハッシュテーブルの説明では，
連続したアドレス空間上の配列要素が，
２辺を共有した四角形の連なりにより表現されることが多い．
しかし，IpCHashT は，linked list を用いた構造のため，
一見すると図\ref{fig_IpCHashT_apparence}のように隣接した連続構造であっても，
実際には，図\ref{fig_IpCHashT_insert_introspection}のように，
各要素が断続的なアドレス空間上に存在することがある．

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_03.pdf}
  \caption{
    IpCHashT に挿入された要素の抽象表現.
    この場合，3 つの要素のハッシュ値は，いずれも first アドレスを示すため，
    linked list により衝突を解決している．
    各要素は prev locator と next locator の示す相対位置により接続されており，
    各要素間に別の要素がある可能性がある．
  }
  \label{fig_IpCHashT_apparence}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_04.pdf}
  \caption{
    図\ref{fig_IpCHashT_apparence}に示す抽象表現を連続アドレス空間上に写像した場合の一例.
    同じ抽象表現でも，挿入と削除の手順により格納状態は異なる．
    ここでは，薄い灰色に囲まれた四角形が配列を示す．
    青字の linked list は図\ref{fig_IpCHashT_apparence}で示された構造を示し，
    赤字の linked list は間に挿入されていた別の chain を示す．
    この例では，手前に空の要素があるにも関わらず，
    青字の linked list の末尾が不用意に遠い場所に格納されており，
    断片化していることが分かる．
  }
  \label{fig_IpCHashT_insert_introspection}
\end{figure}

%\leavevmode \newline
%\leavevmode \newline
%\vspace{-1cm}
\section{挿入}

図\ref{fig_IpCHashT_insert_hard_case01}〜\ref{fig_IpCHashT_insert_hard_case11}に IpCHashT における挿入方法を示す．


\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_06.pdf}
  \caption{ Insertion case01. }
  \label{fig_IpCHashT_insert_hard_case01}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_07.pdf}
  \caption{ Insertion case02. }
  \label{fig_IpCHashT_insert_hard_case02}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_08.pdf}
  \caption{ Insertion case03. }
  \label{fig_IpCHashT_insert_hard_case03}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_09.pdf}
  \caption{ Insertion case04. }
  \label{fig_IpCHashT_insert_hard_case04}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_10.pdf}
  \caption{ Insertion case05. }
  \label{fig_IpCHashT_insert_hard_case05}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_11.pdf}
  \caption{ Insertion case06. }
  \label{fig_IpCHashT_insert_hard_case06}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_12.pdf}
  \caption{ Insertion case07. }
  \label{fig_IpCHashT_insert_hard_case07}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_13.pdf}
  \caption{ Insertion case08. }
  \label{fig_IpCHashT_insert_hard_case08}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_14.pdf}
  \caption{ Insertion case09. }
  \label{fig_IpCHashT_insert_hard_case09}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_15.pdf}
  \caption{ Insertion case10. }
  \label{fig_IpCHashT_insert_hard_case10}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_16.pdf}
  \caption{ Insertion case11. }
  \label{fig_IpCHashT_insert_hard_case11}
\end{figure}





\section{探査}


\section{削除}
\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_18.pdf}
  \caption{ Deletion case01. }
  \label{fig_IpCHashT_deletion_case01}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_19.pdf}
  \caption{ Deletion case02. }
  \label{fig_IpCHashT_deletion_case02}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_20.pdf}
  \caption{ Deletion case03. }
  \label{fig_IpCHashT_deletion_case03}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_21.pdf}
  \caption{ Deletion case04. }
  \label{fig_IpCHashT_deletion_case04}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_22.pdf}
  \caption{ Deletion case05. }
  \label{fig_IpCHashT_deletion_case05}
\end{figure}

\begin{figure}[h]
  \includegraphics[scale=0.73]{./figs_algo/algorism_crop_23.pdf}
  \caption{ Deletion case06. }
  \label{fig_IpCHashT_deletion_case06}
\end{figure}

\section{断片化}

\section{配列確保（パディングの話）}









